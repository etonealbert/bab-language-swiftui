# BringABrainLanguage iOS App - Project Rules

## Project Overview

iOS 18+ language learning app using BabLanguageSDK (Kotlin Multiplatform) for business logic and iOS 26 Foundation Models for on-device AI conversation in solo mode.

**Tech Stack:**
- SwiftUI (iOS 18+)
- SwiftData for local persistence
- BabLanguageSDK (KMP) for business logic
- StoreKit 2 for subscriptions
- Foundation Models (iOS 26+) for on-device LLM

---

## SDK Integration (BabLanguageSDK)

### Initialization
```swift
let sdk = BrainSDK()  // Uses in-memory repositories by default
```

### SDKObserver Pattern
The app uses `SDKObserver` as the bridge between SDK StateFlows and SwiftUI:
- Accepts `ModelContext` at init for SwiftData writes
- Injected via `.environmentObject(sdkObserver)` at app root
- All views access via `@EnvironmentObject var observer: SDKObserver`
- **CRITICAL**: SDKObserver MUST observe SDK StateFlows for UI to update
- **CRITICAL**: Dialog data flows through SwiftData (`@Query`), NOT `@Published` arrays
- Syncs `isPremium` from `SubscriptionManager` → `SDUserProfile` → SDK via `NotificationCenter`

### StateFlow Observation (REQUIRED)
SDK state changes MUST be observed for UI reactivity:
```swift
private func observeSDKState() {
    Task {
        for await profile in sdk.userProfile {
            await MainActor.run { self.userProfile = profile as? UserProfile }
        }
    }
    Task {
        for await state in sdk.state {
            await MainActor.run { self.sessionState = state as? SessionState }
        }
    }
}
```

### Key SDK Types
| Type | Purpose |
|------|---------|
| `SessionState` | Current game state, dialog history, phase |
| `UserProfile` | User preferences, languages, onboarding status, `isPremium` (v1.0.8+) |
| `VocabularyStats` | Word counts, mastery levels |
| `VocabularyEntry` | Individual word with SRS data |
| `UserProgress` | XP, streaks, levels |
| `DialogLine` | Single conversation line |
| `SavedSession` | Completed session history |
| `HistorySession` | SDK v1.0.8 history model (in-memory, premium users get server sync) |

### SDK Method Naming Conventions
- Repository protocols use labeled arguments: `saveProfile(profile:)`, `deleteSession(id:)`
- SDK methods use Swift conventions: `startSoloGame(scenarioId:userRoleId:)`

---

## SwiftData Models (Local Persistence)

### Model Prefix Convention
All SwiftData models use `SD` prefix to distinguish from SDK types:
- `SDUserProfile` (local) vs `UserProfile` (SDK)
- `SDVocabularyEntry` (local) vs `VocabularyEntry` (SDK)
- `SDConversationSession` / `SDConversationMessage` — native conversation persistence

### Property Naming (SwiftData)
| Model | Property | NOT |
|-------|----------|-----|
| `SDUserProfile` | `nativeLanguage` | ~~nativeLanguageCode~~ |
| `SDUserProfile` | `isPremium` | (new in v1.0.8 sync) |
| `SDVocabularyEntry` | `language` | ~~languageCode~~ |
| `SDVocabularyEntry` | `nextReviewAt` | ~~nextReviewDate~~ |
| `SDVocabularyEntry` | `totalReviews` | ~~reviewCount~~ |
| `SDUserProgress` | `totalSessions` | ~~sessionsCompleted~~ |
| `SDConversationMessage` | `sessionId` | Denormalized for `@Query` filtering |

### Schema
- Current: `BabLanguageSchemaV2` (adds `SDConversationSession`, `SDConversationMessage`, `isPremium`)
- Previous: `BabLanguageSchemaV1`
- Migration: `BabLanguageMigrationPlan` with lightweight V1→V2 stage

### Directory Pre-Creation (REQUIRED)
SwiftData's ModelContainer expects Application Support to exist:
```swift
let fileManager = FileManager.default
if let appSupportURL = fileManager.urls(for: .applicationSupportDirectory, in: .userDomainMask).first {
    try? fileManager.createDirectory(at: appSupportURL, withIntermediateDirectories: true)
}
```

---

## iOS Version Requirements

| Feature | Minimum iOS |
|---------|-------------|
| SwiftData | iOS 17+ |
| Zoom Transitions | iOS 18+ |
| SF Symbols 6 effects | iOS 18+ |
| scrollDismissesKeyboard | iOS 16+ |
| @FocusState | iOS 15+ |
| Foundation Models (LLM) | iOS 26+ |

### Conditional Compilation
```swift
#if canImport(FoundationModels)
import FoundationModels
#endif

if #available(iOS 26.0, *) {
    // Runtime check for Foundation Models
}
```

---

## Architecture

```
BringABrainLanguageApp
├── Core/
│   ├── Models/          # SwiftData models (SD* prefix)
│   │   ├── ConversationModels.swift  # SDConversationSession + SDConversationMessage
│   │   └── ...
│   ├── Schema/          # SwiftData schema V2 + migrations
│   ├── SDKObserver.swift # StateFlow bridge + SwiftData writes + LLM orchestration
│   └── LLMBridge/       # iOS 26 Foundation Models
│       ├── LLMBridge.swift    # Low-level FM wrapper
│       └── LLMManager.swift   # Singleton with memory handling
├── Features/
│   ├── Onboarding/      # Multi-step profile setup
│   ├── Home/            # Mode selection + ConnectionTypeSelectionView
│   ├── Lobby/           # HostLobbyView, JoinScanView, RadarPulseView, scenarios
│   ├── Theater/         # Active gameplay (SwiftData @Query for messages)
│   ├── History/         # Persistent chat history (@Query, all users)
│   ├── Vocabulary/      # SRS flashcard review
│   ├── Paywall/         # StoreKit 2 subscriptions + PremiumGate
│   └── Settings/        # User preferences
└── Shared/
    ├── Components/      # Reusable UI (StatPill, etc.)
    └── Extensions/      # View extensions
```

---

## Lobby & Connection Flow

### Navigation Pattern
Host/Join taps → `ConnectionTypeSelectionView` (sheet) → Bluetooth or Online (premium-gated):
- **Bluetooth** → dismisses sheet, pushes `HostLobbyView` or `JoinScanView`
- **Online** → wrapped in `PremiumGate`, locked for non-premium users

### HostLobbyView (Command Center)
- Scenario carousel with SDK sync (`sdk.setLobbyScenario(scenarioId:)`)
- Difficulty segmented picker (`sdk.setLobbyDifficulty(difficultyLevel:)`)
- Connected players list from `BLEHostManager.connectedPeers`
- Start button disabled until ≥1 player joins AND scenario is selected
- LLM availability badge on appear (`LLMBridge().checkAvailability()`)
- BLE advertising lifecycle: `startAdvertising` on appear, `stopAdvertising` on disappear

### JoinScanView
- **Scanning**: `RadarPulseView` animation + discovered hosts list
- **Connected (Guest Lobby)**: Read-only scenario/difficulty from `observer.sessionState?.lobbyState`
- Reacts to host changes via `@Published` on `SDKObserver`

### PremiumGate (REQUIRED for premium features)
Any feature locked behind premium **MUST** be wrapped in `PremiumGate`:
```swift
PremiumGate {
    // Your premium-only content here
    SomeView()
}
```
`PremiumGate` checks `SubscriptionManager.shared.subscriptionStatus` and:
- If `.subscribed`: renders content normally
- If not subscribed: overlays lock icon + presents `PaywallView` on tap

---

## LLM Integration (iOS 26+)

### Architecture
```
SDKObserver → LLMManager → LLMBridge → FoundationModels
```

### Solo Mode Flow (SwiftData-Backed)
1. `initializeTheaterSession(config:)` → creates `SDConversationSession` in SwiftData, stores `currentSessionId`
2. LLM initializes via `LLMManager`
3. `generateNextExchange()` → generates text, writes `SDConversationMessage` to SwiftData
4. TheaterView's inner `TheaterMessageList` uses `@Query` filtered by `sessionId` — UI auto-updates
5. `confirmUserLine()` / `skipUserLine()` → both call `generateNextExchange()` for auto-advance
6. `endTheaterSession(save:)` → marks session complete (save=true) or deletes it (save=false)

### TheaterView Inner-View Pattern
SwiftUI `@Query` cannot use runtime-dynamic predicates from `@EnvironmentObject`.
The solution is a child view that accepts `sessionId` at init:
```swift
private struct TheaterMessageList: View {
    let session: SDConversationSession
    var sortedMessages: [SDConversationMessage] {
        session.messages.sorted { $0.timestamp < $1.timestamp }
    }
    // ...ForEach(sortedMessages) { message in ... }
}
```

### LLM Response Parsing Rules
- Parser uses first-match strategy with `foundAI`/`foundUser` boolean flags
- Strips Markdown formatting (`**`, `*`) from markers before matching
- Stops parsing after finding first complete AI_LINE + USER_LINE pair
- Prompt includes strict single-exchange constraints to prevent multi-turn hallucination

### Memory Pressure Handling
LLMManager automatically disposes session on memory warning and reinitializes on next use.

---

## UI Patterns

### Keyboard Dismissal (REQUIRED)
All TextFields MUST implement proper keyboard dismissal:
```swift
@FocusState private var isTextFieldFocused: Bool

TextField("Input", text: $text)
    .focused($isTextFieldFocused)
    .submitLabel(.send)
    .onSubmit { handleSubmit() }

ScrollView { ... }
    .scrollDismissesKeyboard(.interactively)

VStack { ... }
    .onTapGesture { isTextFieldFocused = false }
```

### Zoom Transitions (iOS 18+)
```swift
// Source (ScenarioCard)
.matchedTransitionSource(id: scenario.id, in: namespace)

// Destination (TheaterView)
.navigationTransition(.zoom(sourceID: scenarioId, in: namespace))
```

### SF Symbols Effects
- `.wiggle` - error/attention
- `.bounce` - tap feedback
- `.breathe` - ongoing activity
- `.rotate` - loading/syncing

### Custom Overlay Pattern (TheaterView)
Confirmation dialogs use ZStack overlays (not system `.alert()`):
```swift
@State private var showEndSessionAlert = false

// In body ZStack:
if showEndSessionAlert {
    endSessionOverlay  // Dimmed bg + centered card + action buttons
}
```
Style: `Color.black.opacity(0.4)` background, `.regularMaterial` card, `RoundedRectangle(cornerRadius: 20)` clip.

---

## Common Patterns

### State Observation in Views
```swift
struct SomeView: View {
    @EnvironmentObject var observer: SDKObserver
    
    var body: some View {
        if let profile = observer.userProfile {
            // Use profile
        }
    }
}
```

### Async SDK Calls
```swift
Button("Complete") {
    Task {
        await observer.completeOnboarding(profile: profile)
    }
}
```

---

## Testing

### Test Commands
```bash
# Build
xcodebuild -scheme BringABrainLanguage -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build

# Run tests
xcodebuild test -scheme BringABrainLanguage -destination 'platform=iOS Simulator,name=iPhone 16 Pro'

# Run specific test class
xcodebuild test -scheme BringABrainLanguage -destination 'platform=iOS Simulator,name=iPhone 16 Pro' -only-testing:BringABrainLanguageTests/LLMBridgeTests
```

### Foundation Models Testing
**Cannot test on simulator** - requires iOS 26 device with Apple Silicon.

---

## Known Issues & Constraints

1. **SDK Module Resolution**: LSP shows "No such module 'BabLanguageSDK'" but build succeeds
2. **FoundationModels Availability**: Only iPhone 15 Pro+ / M-series iPad on iOS 26
3. **SwiftData Directory**: Application Support must be pre-created to avoid sandbox warnings
4. **LSP macOS Mismatch**: LSP may report iOS-only APIs as unavailable (e.g., `.insetGrouped`) — build succeeds on iOS target

---

## File Naming Conventions

| Type | Prefix | Example |
|------|--------|---------|
| SwiftData Model | `SD` | `SDUserProfile.swift` |
| Test File | None, suffix `Tests` | `LLMBridgeTests.swift` |
| View | None | `TheaterView.swift` |
| Manager/Service | None, suffix pattern | `LLMManager.swift` |
